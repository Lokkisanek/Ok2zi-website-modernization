;/*FB_PKG_DELIM*/

__d("LSCreateOpenToE2EEThreadLink",[],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.sequence([function(r){return t.sequence([function(n){return t.db.table(193).put({openThreadId:e[0],armadilloThreadId:e[1],showOpenMessageHistory:e[2],timestampMs:e[3]})},function(e){return n[0]=new t.Map}])},function(e){return t.resolve(r)}])}e.__sproc_name__="LSE2EEMessagingMetadataMailboxCreateOpenToE2EEThreadLinkStoredProcedure",e.__tables__=["cutover_threads"],a.exports=e}),null);
__d("LSIssueCheckBackupStateOnInitSyncTask",["LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSIssueNewEbTaskAndGetTaskIDV2"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(e){return t.sequence([function(e){return t.islc(t.filter(t.db.table(168).fetch(),function(e){return t.i64.eq(e.authorityLevel,t.i64.cast([0,80]))||!1}),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,n){var o,a,i=e.done,l=e.value;return i?(r[6]=new t.Map,r[6].set("error_msg","Expected a nonempty query result"),r[6].set("code",t.i64.cast([0,3])),r[6].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),r[7]=t.createArray(),r[8]=(r[7].push(r[6]),r[7]),o=[void 0,r[7]],r[0]=o[0],r[1]=o[1]):(n=l.item,r[6]=new t.Map,r[6].set("backup_id",n.backupId),r[6].set("device_public_key_blob",n.devicePublicKeyBlob),r[6].set("device_private_key_blob",n.devicePrivateKeyBlob),r[6].set("epoch_storage_public_key_blob",n.epochStoragePublicKeyBlob),r[6].set("epoch_storage_private_key_blob",n.epochStoragePrivateKeyBlob),r[6].set("epoch_auth_public_key_blob",n.epochAuthPublicKeyBlob),r[6].set("epoch_auth_private_key_blob",n.epochAuthPrivateKeyBlob),r[6].set("mailbox_root_key_blob",n.mailboxRootKeyBlob),r[6].set("ocmf_client_state_blob",n.ocmfClientStateBlob),r[6].set("orf_client_state_v2_blob",void 0),r[6].set("orf_v2_authority_level",void 0),r[6].set("oblivious_validation_token_blob",n.obliviousValidationTokenBlob),r[6].set("device_id",n.deviceId),r[6].set("backup_tenancy",n.backupTenancy),r[6].set("encryption_version",n.encryptionVersion),r[6].set("revision_version",n.revisionVersion),r[6].set("initialize_restore_result",void 0),r[6].set("device_creation_timestamp_sec",void 0),r[6].set("authority_level",n.authorityLevel),a=[r[6],void 0],r[0]=a[0],r[1]=a[1])})},function(e){return r[3]=new t.Map,r[3].set("value",r[0]),r[3].set("errors",r[1]),r[4]=r[3].get("value"),r[4]!==void 0?t.sequence([function(e){return r[6]=r[4].get("backup_id"),r[7]=r[4].get("device_public_key_blob"),r[8]=r[4].get("device_private_key_blob"),r[9]=r[4].get("epoch_storage_public_key_blob"),r[10]=r[4].get("epoch_storage_private_key_blob"),r[11]=r[4].get("epoch_auth_public_key_blob"),r[12]=r[4].get("epoch_auth_private_key_blob"),r[13]=r[4].get("mailbox_root_key_blob"),r[14]=r[4].get("ocmf_client_state_blob"),r[15]=r[4].get("orf_client_state_v2_blob"),r[16]=r[4].get("orf_v2_authority_level"),r[17]=r[4].get("oblivious_validation_token_blob"),r[18]=r[4].get("device_id"),r[19]=r[4].get("backup_tenancy"),r[20]=r[4].get("encryption_version"),r[21]=r[4].get("revision_version"),r[22]=r[4].get("initialize_restore_result"),r[23]=r[4].get("device_creation_timestamp_sec"),r[24]=r[4].get("authority_level"),t.i64.neq(r[18],void 0)?t.sequence([function(e){return r[26]=void 0,t.i64.neq(r[26],void 0)?t.resolve(r[27]=r[26]):t.sequence([function(e){return r[33]=t.createArray(),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,0])).then(function(e){var t;return t=e,r[34]=t[0],t})},function(e){return r[34]&&(r[43]=(r[33].push(t.i64.cast([0,0])),r[33])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,2])).then(function(e){var t;return t=e,r[35]=t[0],t})},function(e){return r[35]&&(r[43]=(r[33].push(t.i64.cast([0,2])),r[33])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,3])).then(function(e){var t;return t=e,r[36]=t[0],t})},function(e){return r[36]&&(r[43]=(r[33].push(t.i64.cast([0,3])),r[33])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,4])).then(function(e){var t;return t=e,r[37]=t[0],t})},function(e){return r[37]&&(r[43]=(r[33].push(t.i64.cast([0,4])),r[33])),r[38]=t.createArray(),r[39]=t.i64.of_int32(r[33].length),t.i64.gt(r[39],t.i64.cast([0,0]))?t.loopAsync(r[39],function(e){return r[43]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[33],r[43]).then(function(e){var t;return t=e,r[44]=t[0],r[45]=t[1],t})},function(e){return r[46]=(r[38].push(r[44]),r[38])}])}):t.resolve()},function(e){return t.sequence([function(e){return r[43]=t.createArray(),r[44]=t.i64.of_int32(r[38].length),t.i64.gt(r[44],t.i64.cast([0,0]))?t.loopAsync(r[44],function(e){return r[46]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[38],r[46]).then(function(e){var t;return t=e,r[47]=t[0],r[48]=t[1],t})},function(e){return r[49]=(r[43].push(t.i64.to_string(r[47])),r[43])}])}):t.resolve()},function(e){return r[45]=r[43].join(","),r[40]=r[45]}])},function(e){return r[38].some(function(e){return t.i64.eq(r[20],e)})?r[41]=r[20]:r[41]=void 0,t.i64.neq(r[41],void 0)?r[42]=r[41]:r[42]=void 0,r[27]=r[42]}])},function(e){return t.i64.neq(r[27],void 0)?r[28]=r[27]:r[28]=t.i64.cast([0,0]),t.i64.neq(r[19],void 0)?r[29]=r[19]:r[29]=t.i64.cast([0,1]),r[30]=new t.Map,r[30].set("backup_id",r[6]),r[30].set("device_id",r[18]),r[31]=t.toJSON(r[30]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",t.i64.cast([0,50054]),r[31],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,t.i64.cast([0,0])).then(function(e){var t;return t=e,r[32]=t[0],t})},function(e){return r[25]=!0}]):t.resolve(((function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsIssueCheckBackupStateOnInitSyncTaskStoredProcedure] No client state in checkBackupStateOnInitSyncTask with reason: 24"),r[25]=!1))},function(e){return r[5]=r[25]}]):t.resolve((r[6]=r[3].get("errors"),r[7]=r[3].get("errors"),(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsIssueCheckBackupStateOnInitSyncTaskStoredProcedure] No client state in checkBackupStateOnInitSyncTask with reason: 1"),r[5]=!1))}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsIssueCheckBackupStateOnInitSyncTaskStoredProcedure",e.__tables__=["secure_encrypted_backups_client_state"],a.exports=e}),null);
__d("LSIssueThreadCapabilitySyncTask",[],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.resolve(r)}e.__sproc_name__="LSMailboxIssueThreadCapabilitySyncTaskStoredProcedure",e.__tables__=[],a.exports=e}),null);
__d("LSMoveThreadToE2EECutoverFolder",[],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.sequence([function(n){return t.db.table(9).fetch([[[e[0]]]]).next().then(function(n,r){var o=n.done,a=n.value;return o?0:(r=a.item,t.forEach(t.db.table(9).fetch([[[e[0]]]]),function(e){var n=e.update,r=e.item;return n({folderName:"e2ee_cutover",parentThreadKey:t.i64.cast([-1,4294967279])})}))})},function(e){return t.resolve(r)}])}e.__sproc_name__="LSMailboxMoveThreadToE2EECutoverFolderStoredProcedure",e.__tables__=["threads"],a.exports=e}),null);
__d("LSSetHMPSStatus",[],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.resolve(r)}e.__sproc_name__="LSMailboxSetHMPSStatusStoredProcedure",e.__tables__=[],a.exports=e}),null);
__d("LSShimCopyAllParticipantNicknamesForThread",["gkx"],(function(t,n,r,o,a,i,l){function e(){var e=arguments,t=e[e.length-1],n=[],o=[];return r("gkx")("26379"),t.resolve(o)}e.__sproc_name__="LSMailboxShimCopyAllParticipantNicknamesForThreadStoredProcedure",e.__tables__=[];var s=e;l.default=s}),98);
__d("WABatcher",["Promise","WAResolvable","err"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,o){var a=t.delayMs,i=t.maxSize,l=null;function s(e){return l&&l.args===e&&(l=null),o(e)}var u=function(){if(l==null)return(e||(e=n("Promise"))).resolve();var t=l;return l=null,clearTimeout(t.timer),t.run(),t.batchPromise},c=function(o){if(l)l.args.push(o);else{var t,c=[o],d=new(e||(e=n("Promise")))(function(e){t=function(){return void e(c)}}).then(s),m=t;l={args:c,batchPromise:d,run:m,timer:setTimeout(m,a)}}if(l==null)throw r("err")("activeBatch should not be null here");var p=l,_=p.args,f=p.batchPromise,g=_.length-1;return i!=null&&_.length>=i&&u(),f.then(function(e){return e[g]})};return{accept:c,runActiveBatch:u}}function u(e,t){var n=s(e,t);return function(e){return n.accept(e)}}function c(t){var a=[],i=new(o("WAResolvable")).Resolvable,l=function(l){if(a.length===0)return(e||(e=n("Promise"))).resolve(new Map);var r=a,s=i;return a=[],i=new(o("WAResolvable")).Resolvable,(e||(e=n("Promise"))).resolve(t(r,l)).then(function(e){return s.resolve(e),e})},s=function(t){return a.push(t),i.promise.then(function(e){var n=e.get(t);if(n==null)throw r("err")("This should not happen because we just added it to the batch");return n})};return{accept:s,runActiveBatch:l}}l.createSimpleBatcher=s,l.batch=u,l.createBatcher=c}),98);
__d("LSShimVerifyThreadExists.nop",["I64","LSPlatformArmadilloUtils","LSPlatformLsInitLog","MAWBulkCreateOrUpdateThreadInActWithMiData","MAWJids","MAWMIC","MAWThreadLoadingState","MAWThreadMappingQPL","MAWTrackPendingOccamadilloThreads","MWCookieUtil","MWFBLogger","ReQL","WABatcher","getErrorSafe","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=o("MWFBLogger").MWLogger().tags(["MiActMapping","ThreadReady","Occam"]),d=new Map,m=[];o("LSPlatformArmadilloUtils").executeOnThreadMappingEnd(function(){if(m.length!==0){var e=m.map(function(e){var t=C(e,"LSShimVerifyThreadExists.init_sync");return babelHelpers.extends({instanceKey:t},e)});y(o("MAWBulkCreateOrUpdateThreadInActWithMiData").bulkCreateOrUpdateThreadInActWithMiData(void 0,e,"init_sync"),e.map(function(e){return e.instanceKey}).filter(Boolean),!0)}});var p=200,_=20,f=o("WABatcher").createSimpleBatcher({delayMs:p,maxSize:_},function(e){var t=e.map(function(e){var t=C(e,"LSShimVerifyThreadExists.non-init_sync");return babelHelpers.extends({instanceKey:t},e)});return y(o("MAWBulkCreateOrUpdateThreadInActWithMiData").bulkCreateOrUpdateThreadInActWithMiData(void 0,t,"batched_mapping"),t.map(function(e){return e.instanceKey}).filter(Boolean),!1),[]}),g=async function(n,a,i,l,p,_,g,h,b,v,S,R,L){o("MAWTrackPendingOccamadilloThreads").markThreadPassedToNativeOp({callingSource:L});var t=o("MAWThreadMappingQPL").pendingThreadCreationOnServer.get((u||(u=o("I64"))).to_string(l)),E=await Promise.all([o("ReQL").firstAsync(o("ReQL").fromTableAscending(n.threads).getKeyRange(i)),o("ReQL").firstAsync(o("ReQL").fromTableAscending(n.mi_act_mapping_table).getKeyRange(i))]),k=E[0],I=E[1],T=o("MAWJids").convertIntJidToChatJid(l,g),D=t!=null?t:o("MAWThreadMappingQPL").getInstanceKeyForThreadKey(i);d.set(D,{hasMappingRowAlready:I!=null,isExistingRowPlaceholder:I==null?void 0:(u||(u=o("I64"))).to_float(I.clientThreadPk)<0,isExpectedThreadMissingInLsdb:k==null}),I==null&&await o("MAWThreadLoadingState").markActThreadLoadingAsInProgress(n,i,l),c.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Insert MI thread: fbid:",", jid:",", last activity ts:",", last read ts:",", read=",""])),u.to_string(i),u.to_string(l),u.to_string(h),u.to_string(b),String(u.le(h,b))),(u||(u=o("I64"))).equal(h,(u||(u=o("I64"))).zero)&&c.WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["MI thread insertion with lastActivityTimestamp == 0 for lastReadWatermarkTimestampMs: ",""])),(u||(u=o("I64"))).to_string(b)),o("MAWTrackPendingOccamadilloThreads").addPendingThread(T);var x={description:"LSShimVerifyThreadExists.nop",fbid:i,forceLoadMessages:o("MWCookieUtil").isInChatHead(i),instanceKey:D,isGroupThread:g,jid:l,lastActivityTimestampMs:h,lastReadWatermarkTimestampMs:b},$=o("MWCookieUtil").isAutoChatTabFromCookie(i);$?(C(x,"LSShimVerifyThreadExists.acto"),y(o("MAWBulkCreateOrUpdateThreadInActWithMiData").bulkCreateOrUpdateThreadInActWithMiData(void 0,[x],"acto"),[D],!0)):o("LSPlatformLsInitLog").LsSync.isRunning()?m.push(x):r("promiseDone")(f.accept(x))},h=g;function y(e,t,n){e.catch(function(e){return n&&o("MAWMIC").fail("thread_mapping_error",r("getErrorSafe")(e)),t.forEach(function(t){return o("MAWThreadMappingQPL").endFailureError(e,t)}),e})}function C(e,t){var n=e.instanceKey!=null?d.get(e.instanceKey):null,r=n==null?null:{hasMappingRowAlready:n.hasMappingRowAlready,hasPlaceholderRowInserted:!n.hasMappingRowAlready,isExistingRowPlaceholder:n.isExistingRowPlaceholder,isExpectedThreadMissingInLsdb:n.isExpectedThreadMissingInLsdb};return o("MAWThreadMappingQPL").startOrContinueForMiActMappingParams(e,t,r)}g.__nop_name__="LSShimVerifyThreadExists",l.default=h}),98);
__d("LSVerifyHybridThreadExists",["LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSShimVerifyThreadExists.nop","LSVerifyE2EEMetadataThreadExistsV2"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(o){return t.storedProcedure(n("LSVerifyE2EEMetadataThreadExistsV2"),e[2],e[0],t.i64.cast([0,60])).then(function(e){var t;return t=e,r[0]=t[0],t})},function(o){return r[1]=t.i64.of_float(Date.now()),t.i64.neq(e[11],void 0)?t.sequence([function(e){return t.islc(t.filter(t.db.table(168).fetch(),function(e){return t.i64.eq(e.authorityLevel,t.i64.cast([0,80]))||!1}),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,n){var o,a,i=e.done,l=e.value;return i?(r[10]=new t.Map,r[10].set("error_msg","Expected a nonempty query result"),r[10].set("code",t.i64.cast([0,3])),r[10].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),r[11]=t.createArray(),r[12]=(r[11].push(r[10]),r[11]),o=[void 0,r[11]],r[4]=o[0],r[5]=o[1]):(n=l.item,r[10]=new t.Map,r[10].set("backup_id",n.backupId),r[10].set("device_public_key_blob",n.devicePublicKeyBlob),r[10].set("device_private_key_blob",n.devicePrivateKeyBlob),r[10].set("epoch_storage_public_key_blob",n.epochStoragePublicKeyBlob),r[10].set("epoch_storage_private_key_blob",n.epochStoragePrivateKeyBlob),r[10].set("epoch_auth_public_key_blob",n.epochAuthPublicKeyBlob),r[10].set("epoch_auth_private_key_blob",n.epochAuthPrivateKeyBlob),r[10].set("mailbox_root_key_blob",n.mailboxRootKeyBlob),r[10].set("ocmf_client_state_blob",n.ocmfClientStateBlob),r[10].set("orf_client_state_v2_blob",void 0),r[10].set("orf_v2_authority_level",void 0),r[10].set("oblivious_validation_token_blob",n.obliviousValidationTokenBlob),r[10].set("device_id",n.deviceId),r[10].set("backup_tenancy",n.backupTenancy),r[10].set("encryption_version",n.encryptionVersion),r[10].set("revision_version",n.revisionVersion),r[10].set("initialize_restore_result",void 0),r[10].set("device_creation_timestamp_sec",void 0),r[10].set("authority_level",n.authorityLevel),a=[r[10],void 0],r[4]=a[0],r[5]=a[1])})},function(o){return r[7]=new t.Map,r[7].set("value",r[4]),r[7].set("errors",r[5]),r[8]=r[7].get("value"),r[8]!==void 0?t.sequence([function(o){return r[10]=r[8].get("backup_id"),r[11]=r[8].get("device_public_key_blob"),r[12]=r[8].get("device_private_key_blob"),r[13]=r[8].get("epoch_storage_public_key_blob"),r[14]=r[8].get("epoch_storage_private_key_blob"),r[15]=r[8].get("epoch_auth_public_key_blob"),r[16]=r[8].get("epoch_auth_private_key_blob"),r[17]=r[8].get("mailbox_root_key_blob"),r[18]=r[8].get("ocmf_client_state_blob"),r[19]=r[8].get("orf_client_state_v2_blob"),r[20]=r[8].get("orf_v2_authority_level"),r[21]=r[8].get("oblivious_validation_token_blob"),r[22]=r[8].get("device_id"),r[23]=r[8].get("backup_tenancy"),r[24]=r[8].get("encryption_version"),r[25]=r[8].get("revision_version"),r[26]=r[8].get("initialize_restore_result"),r[27]=r[8].get("device_creation_timestamp_sec"),r[28]=r[8].get("authority_level"),t.i64.neq(r[22],void 0)?t.sequence([function(e){return r[30]=void 0,t.i64.neq(r[30],void 0)?t.resolve(r[31]=r[30]):t.sequence([function(e){return r[34]=t.createArray(),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,0])).then(function(e){var t;return t=e,r[35]=t[0],t})},function(e){return r[35]&&(r[44]=(r[34].push(t.i64.cast([0,0])),r[34])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,2])).then(function(e){var t;return t=e,r[36]=t[0],t})},function(e){return r[36]&&(r[44]=(r[34].push(t.i64.cast([0,2])),r[34])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,3])).then(function(e){var t;return t=e,r[37]=t[0],t})},function(e){return r[37]&&(r[44]=(r[34].push(t.i64.cast([0,3])),r[34])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,4])).then(function(e){var t;return t=e,r[38]=t[0],t})},function(e){return r[38]&&(r[44]=(r[34].push(t.i64.cast([0,4])),r[34])),r[39]=t.createArray(),r[40]=t.i64.of_int32(r[34].length),t.i64.gt(r[40],t.i64.cast([0,0]))?t.loopAsync(r[40],function(e){return r[44]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[34],r[44]).then(function(e){var t;return t=e,r[45]=t[0],r[46]=t[1],t})},function(e){return r[47]=(r[39].push(r[45]),r[39])}])}):t.resolve()},function(e){return t.sequence([function(e){return r[44]=t.createArray(),r[45]=t.i64.of_int32(r[39].length),t.i64.gt(r[45],t.i64.cast([0,0]))?t.loopAsync(r[45],function(e){return r[47]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[39],r[47]).then(function(e){var t;return t=e,r[48]=t[0],r[49]=t[1],t})},function(e){return r[50]=(r[44].push(t.i64.to_string(r[48])),r[44])}])}):t.resolve()},function(e){return r[46]=r[44].join(","),r[41]=r[46]}])},function(e){return r[39].some(function(e){return t.i64.eq(r[24],e)})?r[42]=r[24]:r[42]=void 0,t.i64.neq(r[42],void 0)?r[43]=r[42]:r[43]=void 0,r[31]=r[43]}])},function(n){return t.i64.neq(r[31],void 0)?r[32]=r[31]:r[32]=t.i64.cast([0,0]),t.i64.neq(r[23],void 0)?r[33]=r[23]:r[33]=t.i64.cast([0,1]),r[29]=t.i64.neq(r[22],e[11])}]):t.resolve(r[29]=!1)},function(e){return r[9]=r[29]}]):t.resolve((r[10]=r[7].get("errors"),r[11]=r[7].get("errors"),r[9]=!1))},function(e){return r[2]=r[9]}]):t.resolve(r[2]=!1)},function(o){return r[2]?r[3]=!0:r[3]=e[8],t.nativeOperation(n("LSShimVerifyThreadExists.nop"),e[0],e[1],e[3],e[4],e[5],e[6],e[7],r[3],e[9],e[10],e[12])},function(e){return o[0]=t.i64.cast([0,0])}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSE2EEMessagingMetadataMailboxVerifyHybridThreadExistsStoredProcedure",e.__tables__=["secure_encrypted_backups_client_state"],a.exports=e}),null);